import{s as _,C as L,g as A,a as U}from"./app-ClOTn-KD.js";import{handleStartChat as F}from"./chat-C7iEGgKA.js";const N=document.getElementById("featured-listings-grid"),C=document.getElementById("featured-loading-message"),v=document.getElementById("listings-grid-content"),h=document.getElementById("loading-message"),y=document.getElementById("listing-detail-container"),H=document.getElementById("search-form"),w=document.getElementById("search-input"),x=document.getElementById("location-input"),o=document.getElementById("load-more-btn"),P=document.getElementById("breadcrumb-container");let E=0;const $=8;let k="",M="",S=!0;function O(t,n){let e;return function(...a){clearTimeout(e),e=setTimeout(()=>t.apply(this,a),n)}}function K(t,n=4){t.innerHTML="";for(let e=0;e<n;e++){const a=document.createElement("div");a.className="listing-card skeleton-card",a.innerHTML=`
      <div class="skeleton skeleton-img"></div>
      <div class="skeleton-content">
        <div class="skeleton skeleton-text"></div>
        <div class="skeleton skeleton-text short"></div>
        <div class="skeleton skeleton-text price"></div>
      </div>
    `,t.appendChild(a)}}function G(t,n,e,a=null,i=null){t.innerHTML="";const d=document.createElement("div");if(d.className="empty-state fade-in-section is-visible",d.innerHTML=`
    <i class="fa-solid fa-basket-shopping"></i>
    <h3>${n}</h3>
    <p>${e}</p>
  `,a&&i){const l=document.createElement("button");l.className="btn btn-primary",l.textContent=a,l.onclick=i,d.appendChild(l)}t.appendChild(d)}async function Y(){if(!v)return;console.log("Fetching listings..."),Q(),N&&D();const t=O(()=>{const n=w.value.trim(),e=x.value;n===k&&e===M||(k=n,M=e,E=0,S=!0,o&&(o.style.display="none"),B(),N&&(N.innerHTML="",C&&(C.style.display="block",C.textContent="Searching bulk supply..."),D()))},350);w&&w.addEventListener("input",t),x&&x.addEventListener("change",t),H&&H.addEventListener("submit",n=>{n.preventDefault(),t()}),o&&o.addEventListener("click",()=>{E++,B()}),B()}async function Q(){const t=document.getElementById("location-input");if(!t)return;const{data:n,error:e}=await _.rpc("get_distinct_locations");if(e){console.error("Error fetching locations:",e);return}n.forEach(a=>{if(a.location&&a.location.trim()!==""){const i=document.createElement("option");i.value=a.location,i.textContent=a.location,t.appendChild(i)}})}async function B(){if(!S)return;o&&(o.disabled=!0),E===0?(h&&(h.style.display="none"),K(v,4)):o&&(o.textContent="Loading...");const t=E*$,n=t+$-1;let e=_.from("listings").select("*, profiles ( full_name )").neq("farmer_id",L.COMPANY_USER_ID).order("created_at",{ascending:!1}).range(t,n);k&&(e=e.ilike("product_name",`%${k}%`)),M&&(e=e.eq("location",M));const{data:a,error:i}=await e;if(o&&(o.textContent="Load More",o.disabled=!1),i){E===0&&(v.innerHTML=""),h&&(h.textContent=`Error loading listings: ${i.message}`,h.style.display="block");return}if(E===0&&(v.innerHTML=""),a.length===0&&E===0){h&&(h.style.display="none"),G(v,"No produce found","We couldn't find exactly what you're looking for. Try a different search term or location.","Clear Filters",()=>{w.value="",x.value="",w.dispatchEvent(new Event("input"))}),o&&(o.style.display="none");return}a.length<$?(S=!1,o&&(o.style.display="none")):o&&(o.style.display="block"),q(a,v,null)}async function D(){let t=_.from("listings").select("*, profiles ( full_name )").eq("farmer_id",L.COMPANY_USER_ID).order("created_at",{ascending:!1});k&&(t=t.ilike("product_name",`%${k}%`)),M&&(t=t.eq("location",M));const{data:n,error:e}=await t;e?C.textContent="Error loading featured listings.":n.length===0?(C&&(C.style.display="none"),G(N,"No bulk supply","Our core company has no bulk contracts available matching your criteria.")):q(n,N,C)}function q(t,n,e,a){e&&(e.style.display="none"),t.forEach(i=>{const d=document.createElement("article");d.className="listing-card fade-in-section is-visible";const l=document.createElement("a");l.href=`listing.html?id=${i.id}`,l.className="listing-card-link";const c=document.createElement("img");if(c.loading="lazy",c.decoding="async",i.main_image_url)try{const f=i.main_image_url.split(`/${L.IMAGES.BUCKET}/`)[1];if(f){const{data:g}=_.storage.from(L.IMAGES.BUCKET).getPublicUrl(f,{transform:{width:400,height:300,resize:"cover"}});c.src=g.publicUrl}else c.src=i.main_image_url}catch{c.src="/images/logo.webp"}else c.src="/images/logo.webp";c.alt=i.product_name;const r=document.createElement("div");r.className="listing-card-content";const m=document.createElement("h3");m.textContent=i.product_name;const u=document.createElement("p");u.className="price",u.textContent=`$${i.price} / crate`;const p=document.createElement("p");p.className="location";const b=document.createElement("i");b.className="fa-solid fa-location-dot";const I=document.createTextNode(` ${i.location}`);p.appendChild(b),p.appendChild(I),r.appendChild(m),r.appendChild(u),r.appendChild(p),l.appendChild(c),l.appendChild(r),d.appendChild(l),n.appendChild(d)})}async function W(){var i;if(!y)return;const n=new URLSearchParams(window.location.search).get("id");if(!n){y.innerHTML='<p class="error">Listing not found. <a href="index.html">Go home</a>.</p>';return}const{data:e,error:a}=await _.from("listings").select("*, profiles ( id, full_name )").eq("id",n).single();if(a){y.innerHTML='<p class="error">Error loading listing.</p>';return}if(e){document.title=`${e.product_name} - Seed & Sell`,P&&(P.innerHTML=`<a href="index.html">Home</a> &gt; <a href="index.html#marketplace-container">Marketplace</a> &gt; <span class="current">${e.product_name}</span>`);const d=U(),l=d&&d===e.farmer_id;y.innerHTML="";const c=document.createElement("div");c.className="listing-detail-image-wrapper";const r=document.createElement("img");if(r.id="listing-image",e.main_image_url)try{const s=e.main_image_url.split(`/${L.IMAGES.BUCKET}/`)[1];if(s){const{data:T}=_.storage.from(L.IMAGES.BUCKET).getPublicUrl(s,{transform:{width:800,height:600,resize:"cover"}});r.src=T.publicUrl}else r.src=e.main_image_url}catch{r.src="/images/logo.webp"}else r.src="/images/logo.webp";r.alt=e.product_name,c.appendChild(r);const m=document.createElement("div");m.className="listing-detail-info";const u=document.createElement("h2");u.id="listing-title",u.textContent=e.product_name;const p=document.createElement("p");p.id="listing-price",p.textContent=`$${e.price} / crate`;const b=document.createElement("div");b.className="listing-meta-group",b.innerHTML=`
      <p class="listing-meta-item"><i class="fa-solid fa-cubes"></i> <span><strong>Available:</strong> ${e.quantity_available||"Not specified"} crates</span></p>
      <p class="listing-meta-item"><i class="fa-solid fa-location-dot"></i> <span><strong>Location:</strong> ${e.location}</span></p>
    `;const I=document.createElement("div");I.className="listing-description-card",I.innerHTML=`<h3>Description</h3><p>${e.description||"No description provided."}</p>`,m.appendChild(u),m.appendChild(p),m.appendChild(b),m.appendChild(I);const f=document.createElement("div");f.className="listing-detail-sidebar";const g=document.createElement("div");if(g.className="farmer-details-card",g.innerHTML=`<h3>Farmer Details</h3><p class="listing-meta-item"><i class="fa-solid fa-user"></i> <span><strong>Contact:</strong> ${((i=e.profiles)==null?void 0:i.full_name)||"Unknown"}</span></p>`,l){const s=document.createElement("a");s.href=`/dashboard.html?edit_id=${e.id}`,s.className="btn btn-primary btn-full-width",s.textContent="Edit Your Listing",g.appendChild(s)}else{const s=document.createElement("button");s.className="btn btn-primary btn-full-width",s.textContent="Chat with Farmer",s.onclick=()=>{const T=A();if(!T)return alert("Please log in as a Buyer to chat.");if(T.user_role==="farmer")return alert("Farmers cannot chat with other farmers.");F(e.profiles.id,U())},g.appendChild(s)}f.appendChild(g),y.appendChild(c),y.appendChild(m),y.appendChild(f)}}export{W as initListingDetailPage,Y as initListingsPage};
