import{a as _,s as d}from"./app-D1aMIInP.js";const p=document.getElementById("listing-form"),E=document.getElementById("listing-message"),s=document.getElementById("submit-listing-btn"),h=document.getElementById("my-listings-grid"),m=document.getElementById("my-listings-loading"),f=document.getElementById("product-category"),g=document.getElementById("product-subcategory"),C=document.getElementById("quantity-label"),T=document.querySelectorAll(".dashboard-nav-link"),x=document.querySelectorAll(".dashboard-panel"),S=document.getElementById("profile-form"),B=document.getElementById("profile-message"),y=document.getElementById("profile-submit-btn");let l=null;const M={produce:{label:"Farm Produce",unit:"Quantity (Crates, Buckets, Tons)",types:["Maize","Tomatoes","Onions","Leafy Vegetables (Covo/Rape)","Potatoes","Poultry (Road Runners/Broilers)","Beef/Livestock","Goats","Eggs","Mushrooms","Soya Beans","Tobacco"]},inputs:{label:"Farm Inputs",unit:"Quantity (Bags, Litres, KGs)",types:["Maize Seed (Short Season)","Maize Seed (Long Season)","Fertilizer (Compound D)","Fertilizer (AN)","Fertilizer (Super D)","Lime","Herbicides","Pesticides","Stockfeed","Veterinary Medicine"]},services:{label:"Services",unit:"Availability (Hours, Hectares, Trips)",types:["Tractor Ploughing","Crop Spraying","Transport/Logistics","Borehole Drilling","Harvesting","Veterinary Services","Farm Fencing","Consultancy/Agronomy"]}};function F(){const n=_();if(!n){setTimeout(()=>{_()&&F()},500);return}const t=document.querySelector(".dashboard-layout");t&&t.classList.add("is-ready");const e=document.getElementById("verification-banner");e&&(e.style.display="block"),H(),U(n),L(n);const i=document.getElementById("profile-phone");i&&window.intlTelInput&&!l&&(l=window.intlTelInput(i,{initialCountry:"zw",preferredCountries:["zw","za"],separateDialCode:!0,utilsScript:"https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/utils.js"}));const a=document.getElementById("dashboard-logout-btn");a&&a.addEventListener("click",u=>{u.preventDefault();const w=document.getElementById("logout-modal");w&&w.classList.add("is-visible")}),f&&f.addEventListener("change",b),S&&S.addEventListener("submit",u=>$(u,n)),p&&p.addEventListener("submit",u=>k(u,n));const o=document.getElementById("product-image");o&&o.addEventListener("change",N);const c=new URLSearchParams(window.location.search).get("edit_id");c?(z(c,n),v("form-panel")):v("profile-panel")}function b(){const n=f.value,t=M[n];t&&C&&(C.textContent=t.unit),g.innerHTML='<option value="" disabled selected>-- Select Type --</option>',t?(g.disabled=!1,t.types.forEach(e=>{const i=document.createElement("option");i.value=e,i.textContent=e,g.appendChild(i)})):g.disabled=!0}function H(){T.forEach(n=>{n.id!=="dashboard-logout-btn"&&n.addEventListener("click",t=>{t.preventDefault();const e=n.dataset.panel;v(e)})})}function v(n){x.forEach(i=>i.classList.remove("active")),T.forEach(i=>i.classList.remove("active"));const t=document.getElementById(n);t&&t.classList.add("active");const e=document.querySelector(`.dashboard-nav-link[data-panel="${n}"]`);e&&(e.classList.add("active"),window.location.hash=e.hash)}async function U(n){const{data:t}=await d.from("profiles").select("full_name, phone_number, location").eq("id",n).single();t&&(document.getElementById("profile-name").value=t.full_name,l?l.setNumber(t.phone_number):document.getElementById("profile-phone").value=t.phone_number,document.getElementById("profile-location").value=t.location)}async function $(n,t){if(n.preventDefault(),l&&!l.isValidNumber()){I("Invalid phone number.","error");return}y.disabled=!0,y.innerHTML='<span class="spinner"></span>Updating...';const e=document.getElementById("profile-name").value,i=l?l.getNumber():document.getElementById("profile-phone").value,a=document.getElementById("profile-location").value,{error:o}=await d.from("profiles").update({full_name:e,phone_number:i,location:a}).eq("id",t);o?I(`Error: ${o.message}`,"error"):(I("Profile updated!","success"),l&&l.setNumber(i)),y.disabled=!1,y.innerHTML="Update Profile"}async function z(n,t){r("Loading listing...","success");const{data:e,error:i}=await d.from("listings").select("*").eq("id",n).eq("farmer_id",t).single();if(i||!e){r("Error loading listing.","error");return}document.getElementById("listing-id").value=e.id,document.getElementById("product-name").value=e.product_name,document.getElementById("product-price").value=e.price,document.getElementById("product-quantity").value=e.quantity_available,document.getElementById("product-location").value=e.location,document.getElementById("product-description").value=e.description,e.category&&M[e.category]?(f.value=e.category,b(),e.sub_category&&(g.value=e.sub_category)):(f.value="produce",b()),document.getElementById("form-title").innerHTML='<i class="fa-solid fa-pen-to-square icon"></i> Edit Listing',s.textContent="Update Listing";let a=document.getElementById("image-preview-wrapper");a||(a=document.createElement("div"),a.id="image-preview-wrapper",p.insertBefore(a,s)),a.innerHTML=`<img src="${e.main_image_url}" alt="Current image">`,r("Loaded. Make changes and Update.","success")}function N(n){const t=n.target.files[0];let e=document.getElementById("image-preview-wrapper");if(e||(e=document.createElement("div"),e.id="image-preview-wrapper",p.insertBefore(e,s)),e.innerHTML="",t){const i=new FileReader;i.onload=a=>{const o=document.createElement("img");o.src=a.target.result,e.appendChild(o)},i.readAsDataURL(t)}}async function k(n,t){n.preventDefault();const e=document.getElementById("listing-id").value;e?await R(n,t,e):await A(n,t),L(t)}async function A(n,t){if(!q())return;s.disabled=!0,s.innerHTML='<span class="spinner"></span>Uploading...';const e=P(),i=document.getElementById("product-image").files[0];if(!i){r("Image required.","error"),s.disabled=!1;return}const a=await D(i,t);if(!a){s.disabled=!1;return}e.main_image_url=a,e.farmer_id=t;const{error:o}=await d.from("listings").insert(e);o?r(o.message,"error"):(r("Listing posted successfully!","success"),p.reset(),document.getElementById("image-preview-wrapper").innerHTML="",b(),v("listings-panel")),s.disabled=!1,s.textContent="Post Listing"}async function R(n,t,e){if(!q())return;s.disabled=!0,s.innerHTML='<span class="spinner"></span>Updating...';const i=P(),a=document.getElementById("product-image").files[0];if(a){const c=await D(a,t);c&&(i.main_image_url=c)}const{error:o}=await d.from("listings").update(i).eq("id",e);o?r(o.message,"error"):(r("Listing updated!","success"),setTimeout(()=>r(""),3e3)),s.disabled=!1,s.textContent="Update Listing"}function P(){return{category:document.getElementById("product-category").value,sub_category:document.getElementById("product-subcategory").value,product_name:document.getElementById("product-name").value,price:document.getElementById("product-price").value,quantity_available:document.getElementById("product-quantity").value,location:document.getElementById("product-location").value,description:document.getElementById("product-description").value}}function q(){const n=document.getElementById("product-category").value,t=document.getElementById("product-subcategory").value,e=parseFloat(document.getElementById("product-price").value);return n?t?isNaN(e)||e<=0?(r("Price must be valid.","error"),!1):!0:(r("Please select a Sub-Category.","error"),!1):(r("Please select a Category.","error"),!1)}async function D(n,t){r("Uploading image...","success");const e=`public/${t}_${Date.now()}_${n.name.replace(/[^a-zA-Z0-9.]/g,"")}`,{error:i}=await d.storage.from("product_images").upload(e,n);if(i)return r(`Upload failed: ${i.message}`,"error"),null;const{data:a}=d.storage.from("product_images").getPublicUrl(e);return a.publicUrl}async function L(n){if(!h)return;m.textContent="Loading listings...";const{data:t,error:e}=await d.from("listings").select("*").eq("farmer_id",n).order("created_at",{ascending:!1});e?m.textContent="Error loading.":(h.innerHTML="",t.length===0?(m.textContent="No listings yet.",m.style.display="block"):(m.style.display="none",t.forEach(i=>{const a=document.createElement("div");a.className="listing-card",a.innerHTML=`
          <div class="listing-card-content" style="padding:1rem;">
            <h4 style="margin:0 0 0.5rem 0; font-size:1rem; color:#666; text-transform:uppercase; font-size:0.8rem; font-weight:700;">
              ${i.category||"Produce"} - ${i.sub_category||"General"}
            </h4>
            <h3 style="margin:0 0 0.5rem 0;">${i.product_name}</h3>
            <p style="color:var(--primary-color); font-weight:700;">$${i.price}</p>
          </div>
          <div class="listing-card-actions" style="padding:0 1rem 1rem 1rem; display:flex; gap:0.5rem;">
            <a href="/dashboard.html?edit_id=${i.id}" class="btn edit-btn" style="flex:1; text-align:center;">Edit</a>
            <button class="btn delete-btn" data-id="${i.id}" style="flex:1;">Delete</button>
          </div>
        `,a.querySelector(".delete-btn").addEventListener("click",()=>G(i.id,n)),h.appendChild(a)})))}async function G(n,t){confirm("Delete this listing?")&&(await d.from("listings").delete().eq("id",n).eq("farmer_id",t),L(t))}function r(n,t){E&&(E.textContent=n,E.className=t)}function I(n,t){B&&(B.textContent=n,B.className=t)}export{F as initDashboardPage};
