import{b as y,s as u,a as L,c as _}from"./app-Cz4uy1Bm.js";const f=document.getElementById("room-list"),g=document.getElementById("chat-header"),d=document.getElementById("chat-messages"),m=document.getElementById("chat-input-form"),h=document.getElementById("message-input");let p=null,b=null;async function H(e,t){const{data:a}=await u.from("chat_rooms").select("id").eq("buyer_id",t).eq("farmer_id",e).single();if(a)window.location.href="/messages.html?room_id=".concat(a.id);else{const{data:n,error:s}=await u.from("chat_rooms").insert({buyer_id:t,farmer_id:e}).select("id").single();s?alert("Error starting chat."):window.location.href="/messages.html?room_id=".concat(n.id)}}function S(){const e=L();if(!e){setTimeout(S,200);return}if(y(),m){const t=m.querySelector("button");t&&(t.innerHTML='<i class="fa-solid fa-paper-plane"></i>'),m.addEventListener("submit",a=>T(a,e))}v(e)}async function v(e){if(!f)return;const t=await _(),{data:a,error:n}=await u.from("chat_rooms").select("id, buyer_id, farmer_id, buyer:buyer_id ( full_name ), farmer:farmer_id ( full_name )").or("buyer_id.eq.".concat(e,",farmer_id.eq.").concat(e));if(n){f.innerHTML="<p style='padding:1rem'>Error loading conversations.</p>";return}if(a.length===0){f.innerHTML="<p style='padding:1rem'>No conversations yet.</p>",g&&(g.textContent=""),d&&(d.innerHTML='\n      <div class="chat-empty-state">\n        <i class="fa-solid fa-comments"></i>\n        <p>No messages selected</p>\n        <span>Select a conversation to start chatting.</span>\n      </div>\n    '),m&&(m.style.display="none");return}m&&(m.style.display="flex"),f.innerHTML="",a.forEach(o=>{const l=e===o.buyer_id?o.farmer.full_name:o.buyer.full_name,c=document.createElement("div");if(c.className="room-item",c.appendChild(document.createTextNode(l)),c.dataset.roomId=o.id,c.dataset.roomName=l,t&&t[o.id]){const r=document.createElement("span");r.className="room-notification-bubble",r.textContent=t[o.id],c.appendChild(r)}c.addEventListener("click",()=>{document.querySelector(".chat-container").classList.add("chat-active"),C(o.id,l,e)}),f.appendChild(c)});const i=new URLSearchParams(window.location.search).get("room_id");if(i){const o=document.querySelector('.room-item[data-room-id="'.concat(i,'"]'));o&&o.click()}}async function C(e,t,a){p=e,b=null;const n="/messages.html?room_id=".concat(e);window.history.pushState({path:n},"",n);const s=document.querySelector('.room-item[data-room-id="'.concat(e,'"]'));if(s){s.classList.add("active-room");const r=s.querySelector(".room-notification-bubble");r&&(r.style.display="none")}document.querySelectorAll(".room-item").forEach(r=>{r!==s&&r.classList.remove("active-room")}),g.innerHTML="";const i=document.createElement("button");i.id="chat-back-btn",i.className="chat-back-btn",i.innerHTML='<i class="fa-solid fa-arrow-left"></i>',i.addEventListener("click",()=>{document.querySelector(".chat-container").classList.remove("chat-active"),p=null,y(),window.history.pushState({path:"/messages.html"},"","/messages.html")});const o=document.createElement("p");o.textContent=t,g.appendChild(i),g.appendChild(o),d.innerHTML="<p style='padding:2rem; text-align:center;'>Loading messages...</p>",await u.from("chat_messages").update({is_read:!0}).eq("room_id",e).neq("sender_id",a),await _();const{data:l,error:c}=await u.from("chat_messages").select("*").eq("room_id",e).order("created_at");if(c){d.innerHTML="<p>Error loading messages.</p>";return}d.innerHTML="",l.forEach(r=>{w(r,a)}),E(),y()}function w(e,t){const a=D(e.created_at);if(a){const o=document.createElement("div");o.className="date-header",o.textContent=a,d.appendChild(o)}const n=document.createElement("div");n.id="msg-".concat(e.id),n.className="message-bubble",n.classList.add(e.sender_id===t?"sender":"receiver");const s=document.createElement("span");s.textContent=e.message_content;const i=document.createElement("span");i.className="message-time",i.textContent=M(e.created_at),n.appendChild(s),n.appendChild(i),d.appendChild(n)}function E(){d.scrollTop=d.scrollHeight}async function T(e,t){if(e.preventDefault(),!p)return;const a=h.value.trim();if(a.length===0)return;h.disabled=!0;const n="temp-".concat(Date.now()),s={id:n,sender_id:t,message_content:a,created_at:new Date().toISOString()};w(s,t),E(),h.value="";const{data:i,error:o}=await u.from("chat_messages").insert({room_id:p,sender_id:t,message_content:a}).select().single();if(o)console.error("Error sending:",o.message);else{const l=document.getElementById("msg-".concat(n));l&&(l.id="msg-".concat(i.id))}h.disabled=!1,h.focus()}function M(e){return new Date(e).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})}function D(e){const t=new Date(e),a=new Date,n=new Date(a);n.setDate(n.getDate()-1);const s=t.toLocaleDateString();return b===s?null:(b=s,s===a.toLocaleDateString()?"Today":s===n.toLocaleDateString()?"Yesterday":t.toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"}))}export{H as handleStartChat,S as initChatPage};
