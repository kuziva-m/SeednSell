System.register(["./app-legacy-0mN-NWaE.js"],function(e,t){"use strict";var n,a;return{setters:[e=>{n=e.a,a=e.s}],execute:function(){e("initDashboardPage",function e(){const i=n();if(!i)return void setTimeout(()=>{n()&&e()},500);const r=document.querySelector(".dashboard-layout");r&&r.classList.add("is-ready");const s=document.getElementById("verification-banner");s&&(s.style.display="block"),u.forEach(e=>{"dashboard-logout-btn"!==e.id&&e.addEventListener("click",t=>{t.preventDefault(),b(e.dataset.panel)})}),async function(e){const{data:t}=await a.from("profiles").select("full_name, phone_number, location").eq("id",e).single();t&&(document.getElementById("profile-name").value=t.full_name,f?f.setNumber(t.phone_number):document.getElementById("profile-phone").value=t.phone_number,document.getElementById("profile-location").value=t.location)}(i),w(i);const c=document.getElementById("profile-phone");c&&window.intlTelInput&&!f&&(f=window.intlTelInput(c,{initialCountry:"zw",preferredCountries:["zw","za"],separateDialCode:!0,utilsScript:"https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/utils.js"}));const m=document.getElementById("dashboard-logout-btn");m&&m.addEventListener("click",e=>{e.preventDefault();const t=document.getElementById("logout-modal");t&&t.classList.add("is-visible")}),d&&d.addEventListener("change",E),p&&p.addEventListener("submit",e=>async function(e,t){if(e.preventDefault(),f&&!f.isValidNumber())return void _("Invalid phone number.","error");y.disabled=!0,y.innerHTML='<span class="spinner"></span>Updating...';const n=document.getElementById("profile-name").value,i=f?f.getNumber():document.getElementById("profile-phone").value,o=document.getElementById("profile-location").value,{error:r}=await a.from("profiles").update({full_name:n,phone_number:i,location:o}).eq("id",t);r?_(`Error: ${r.message}`,"error"):(_("Profile updated!","success"),f&&f.setNumber(i)),y.disabled=!1,y.innerHTML="Update Profile"}(e,i)),t&&t.addEventListener("submit",e=>async function(e,n){e.preventDefault();const i=document.getElementById("listing-id").value;i?await async function(e,t,n){if(!I())return;o.disabled=!0,o.innerHTML='<span class="spinner"></span>Updating...';const i=h(),r=document.getElementById("product-image").files[0];if(r){const e=await L(r,t);e&&(i.main_image_url=e)}const{error:s}=await a.from("listings").update(i).eq("id",n);s?C(s.message,"error"):(C("Listing updated!","success"),setTimeout(()=>C(""),3e3)),o.disabled=!1,o.textContent="Update Listing"}(0,n,i):await async function(e,n){if(!I())return;o.disabled=!0,o.innerHTML='<span class="spinner"></span>Uploading...';const i=h(),r=document.getElementById("product-image").files[0];if(!r)return C("Image required.","error"),void(o.disabled=!1);const s=await L(r,n);if(!s)return void(o.disabled=!1);i.main_image_url=s,i.farmer_id=n;const{error:d}=await a.from("listings").insert(i);d?C(d.message,"error"):(C("Listing posted successfully!","success"),t.reset(),document.getElementById("image-preview-wrapper").innerHTML="",E(),b("listings-panel")),o.disabled=!1,o.textContent="Post Listing"}(0,n),w(n)}(e,i));const g=document.getElementById("product-image");g&&g.addEventListener("change",B);const x=new URLSearchParams(window.location.search).get("edit_id");x?(async function(e,n){C("Loading listing...","success");const{data:i,error:r}=await a.from("listings").select("*").eq("id",e).eq("farmer_id",n).single();if(r||!i)return void C("Error loading listing.","error");document.getElementById("listing-id").value=i.id,document.getElementById("product-name").value=i.product_name,document.getElementById("product-price").value=i.price,document.getElementById("product-quantity").value=i.quantity_available,document.getElementById("product-location").value=i.location,document.getElementById("product-description").value=i.description,i.category&&v[i.category]?(d.value=i.category,E(),i.sub_category&&(l.value=i.sub_category)):(d.value="produce",E()),document.getElementById("form-title").innerHTML='<i class="fa-solid fa-pen-to-square icon"></i> Edit Listing',o.textContent="Update Listing";let s=document.getElementById("image-preview-wrapper");s||(s=document.createElement("div"),s.id="image-preview-wrapper",t.insertBefore(s,o)),s.innerHTML=`<img src="${i.main_image_url}" alt="Current image">`,C("Loaded. Make changes and Update.","success")}(x,i),b("form-panel")):b("profile-panel")});const t=document.getElementById("listing-form"),i=document.getElementById("listing-message"),o=document.getElementById("submit-listing-btn"),r=document.getElementById("my-listings-grid"),s=document.getElementById("my-listings-loading"),d=document.getElementById("product-category"),l=document.getElementById("product-subcategory"),c=document.getElementById("quantity-label"),u=document.querySelectorAll(".dashboard-nav-link"),m=document.querySelectorAll(".dashboard-panel"),p=document.getElementById("profile-form"),g=document.getElementById("profile-message"),y=document.getElementById("profile-submit-btn");let f=null;const v={produce:{label:"Farm Produce",unit:"Quantity (Crates, Buckets, Tons)",types:["Maize","Tomatoes","Onions","Leafy Vegetables (Covo/Rape)","Potatoes","Poultry (Road Runners/Broilers)","Beef/Livestock","Goats","Eggs","Mushrooms","Soya Beans","Tobacco"]},inputs:{label:"Farm Inputs",unit:"Quantity (Bags, Litres, KGs)",types:["Maize Seed (Short Season)","Maize Seed (Long Season)","Fertilizer (Compound D)","Fertilizer (AN)","Fertilizer (Super D)","Lime","Herbicides","Pesticides","Stockfeed","Veterinary Medicine"]},services:{label:"Services",unit:"Availability (Hours, Hectares, Trips)",types:["Tractor Ploughing","Crop Spraying","Transport/Logistics","Borehole Drilling","Harvesting","Veterinary Services","Farm Fencing","Consultancy/Agronomy"]}};function E(){const e=d.value,t=v[e];t&&c&&(c.textContent=t.unit),l.innerHTML='<option value="" disabled selected>-- Select Type --</option>',t?(l.disabled=!1,t.types.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,l.appendChild(t)})):l.disabled=!0}function b(e){m.forEach(e=>e.classList.remove("active")),u.forEach(e=>e.classList.remove("active"));const t=document.getElementById(e);t&&t.classList.add("active");const n=document.querySelector(`.dashboard-nav-link[data-panel="${e}"]`);n&&(n.classList.add("active"),window.location.hash=n.hash)}function B(e){const n=e.target.files[0];let a=document.getElementById("image-preview-wrapper");if(a||(a=document.createElement("div"),a.id="image-preview-wrapper",t.insertBefore(a,o)),a.innerHTML="",n){const e=new FileReader;e.onload=e=>{const t=document.createElement("img");t.src=e.target.result,a.appendChild(t)},e.readAsDataURL(n)}}function h(){return{category:document.getElementById("product-category").value,sub_category:document.getElementById("product-subcategory").value,product_name:document.getElementById("product-name").value,price:document.getElementById("product-price").value,quantity_available:document.getElementById("product-quantity").value,location:document.getElementById("product-location").value,description:document.getElementById("product-description").value}}function I(){const e=document.getElementById("product-category").value,t=document.getElementById("product-subcategory").value,n=parseFloat(document.getElementById("product-price").value);return e?t?!(isNaN(n)||n<=0)||(C("Price must be valid.","error"),!1):(C("Please select a Sub-Category.","error"),!1):(C("Please select a Category.","error"),!1)}async function L(e,t){C("Uploading image...","success");const n=`public/${t}_${Date.now()}_${e.name.replace(/[^a-zA-Z0-9.]/g,"")}`,{error:i}=await a.storage.from("product_images").upload(n,e);if(i)return C(`Upload failed: ${i.message}`,"error"),null;const{data:o}=a.storage.from("product_images").getPublicUrl(n);return o.publicUrl}async function w(e){if(!r)return;s.textContent="Loading listings...";const{data:t,error:n}=await a.from("listings").select("*").eq("farmer_id",e).order("created_at",{ascending:!1});n?s.textContent="Error loading.":(r.innerHTML="",0===t.length?(s.textContent="No listings yet.",s.style.display="block"):(s.style.display="none",t.forEach(t=>{const n=document.createElement("div");n.className="listing-card";const i=document.createElement("div");i.className="listing-card-content",i.style.padding="1rem";const o=document.createElement("h4");o.style.cssText="margin:0 0 0.5rem 0; font-size:1rem; color:#666; text-transform:uppercase; font-size:0.8rem; font-weight:700;",o.textContent=`${t.category||"Produce"} - ${t.sub_category||"General"}`;const s=document.createElement("h3");s.style.margin="0 0 0.5rem 0",s.textContent=t.product_name;const d=document.createElement("p");d.style.cssText="color:var(--primary-color); font-weight:700;",d.textContent=`$${t.price}`,i.appendChild(o),i.appendChild(s),i.appendChild(d);const l=document.createElement("div");l.className="listing-card-actions",l.style.cssText="padding:0 1rem 1rem 1rem; display:flex; gap:0.5rem;";const c=document.createElement("a");c.href=`/dashboard.html?edit_id=${t.id}`,c.className="btn edit-btn",c.style.cssText="flex:1; text-align:center;",c.textContent="Edit";const u=document.createElement("button");u.className="btn delete-btn",u.dataset.id=t.id,u.style.flex="1",u.textContent="Delete",u.addEventListener("click",()=>async function(e,t){confirm("Delete this listing?")&&(await a.from("listings").delete().eq("id",e).eq("farmer_id",t),w(t))}(t.id,e)),l.appendChild(c),l.appendChild(u),n.appendChild(i),n.appendChild(l),r.appendChild(n)})))}function C(e,t){i&&(i.textContent=e,i.className=t)}function _(e,t){g&&(g.textContent=e,g.className=t)}}}});
