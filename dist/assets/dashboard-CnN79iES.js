import{a as B,s as l}from"./app-ClOTn-KD.js";const u=document.getElementById("listing-form"),y=document.getElementById("listing-message"),r=document.getElementById("submit-listing-btn"),v=document.getElementById("my-listings-grid"),d=document.getElementById("my-listings-loading"),m=document.getElementById("product-category"),c=document.getElementById("product-subcategory"),L=document.getElementById("quantity-label"),_=document.querySelectorAll(".dashboard-nav-link"),P=document.querySelectorAll(".dashboard-panel"),I=document.getElementById("profile-form"),b=document.getElementById("profile-message"),g=document.getElementById("profile-submit-btn"),C={produce:{label:"Farm Produce",unit:"Quantity (Crates, Buckets, Tons)",types:["Maize","Tomatoes","Onions","Leafy Vegetables (Covo/Rape)","Potatoes","Poultry (Road Runners/Broilers)","Beef/Livestock","Goats","Eggs","Mushrooms","Soya Beans","Tobacco"]},inputs:{label:"Farm Inputs",unit:"Quantity (Bags, Litres, KGs)",types:["Maize Seed (Short Season)","Maize Seed (Long Season)","Fertilizer (Compound D)","Fertilizer (AN)","Fertilizer (Super D)","Lime","Herbicides","Pesticides","Stockfeed","Veterinary Medicine"]},services:{label:"Services",unit:"Availability (Hours, Hectares, Trips)",types:["Tractor Ploughing","Crop Spraying","Transport/Logistics","Borehole Drilling","Harvesting","Veterinary Services","Farm Fencing","Consultancy/Agronomy"]}};function q(){const n=B();if(!n){setTimeout(()=>{B()&&q()},500);return}const e=document.querySelector(".dashboard-layout");e&&e.classList.add("is-ready"),D(),x(n),E(n),m&&m.addEventListener("change",p),I&&I.addEventListener("submit",a=>F(a,n)),u&&u.addEventListener("submit",a=>$(a,n));const t=document.getElementById("product-image");t&&t.addEventListener("change",U);const i=new URLSearchParams(window.location.search).get("edit_id");i?(H(i,n),f("form-panel")):f("profile-panel")}function p(){const n=m.value,e=C[n];e&&L&&(L.textContent=e.unit),c.innerHTML='<option value="" disabled selected>-- Select Type --</option>',e?(c.disabled=!1,e.types.forEach(t=>{const i=document.createElement("option");i.value=t,i.textContent=t,c.appendChild(i)})):c.disabled=!0}function D(){_.forEach(n=>{n.addEventListener("click",e=>{e.preventDefault();const t=n.dataset.panel;f(t)})})}function f(n){P.forEach(i=>i.classList.remove("active")),_.forEach(i=>i.classList.remove("active"));const e=document.getElementById(n);e&&e.classList.add("active");const t=document.querySelector(`.dashboard-nav-link[data-panel="${n}"]`);t&&(t.classList.add("active"),window.location.hash=t.hash)}async function x(n){const{data:e}=await l.from("profiles").select("full_name, phone_number, location").eq("id",n).single();e&&(document.getElementById("profile-name").value=e.full_name,document.getElementById("profile-phone").value=e.phone_number,document.getElementById("profile-location").value=e.location)}async function F(n,e){n.preventDefault(),g.disabled=!0,g.innerHTML='<span class="spinner"></span>Updating...';const t=document.getElementById("profile-name").value,i=A(document.getElementById("profile-phone").value),a=document.getElementById("profile-location").value,{error:s}=await l.from("profiles").update({full_name:t,phone_number:i,location:a}).eq("id",e);s?w(`Error: ${s.message}`,"error"):(w("Profile updated!","success"),document.getElementById("profile-phone").value=i),g.disabled=!1,g.innerHTML="Update Profile"}async function H(n,e){o("Loading listing...","success");const{data:t,error:i}=await l.from("listings").select("*").eq("id",n).eq("farmer_id",e).single();if(i||!t){o("Error loading listing.","error");return}document.getElementById("listing-id").value=t.id,document.getElementById("product-name").value=t.product_name,document.getElementById("product-price").value=t.price,document.getElementById("product-quantity").value=t.quantity_available,document.getElementById("product-location").value=t.location,document.getElementById("product-description").value=t.description,t.category&&C[t.category]?(m.value=t.category,p(),t.sub_category&&(c.value=t.sub_category)):(m.value="produce",p()),document.getElementById("form-title").innerHTML='<i class="fa-solid fa-pen-to-square icon"></i> Edit Listing',r.textContent="Update Listing";let a=document.getElementById("image-preview-wrapper");a||(a=document.createElement("div"),a.id="image-preview-wrapper",u.insertBefore(a,r)),a.innerHTML=`<img src="${t.main_image_url}" alt="Current image">`,o("Loaded. Make changes and Update.","success")}function U(n){const e=n.target.files[0];let t=document.getElementById("image-preview-wrapper");if(t||(t=document.createElement("div"),t.id="image-preview-wrapper",u.insertBefore(t,r)),t.innerHTML="",e){const i=new FileReader;i.onload=a=>{const s=document.createElement("img");s.src=a.target.result,t.appendChild(s)},i.readAsDataURL(e)}}async function $(n,e){n.preventDefault();const t=document.getElementById("listing-id").value;t?await z(n,e,t):await k(n,e),E(e)}async function k(n,e){if(!M())return;r.disabled=!0,r.innerHTML='<span class="spinner"></span>Uploading...';const t=S(),i=document.getElementById("product-image").files[0];if(!i){o("Image required.","error"),r.disabled=!1;return}const a=await T(i,e);if(!a){r.disabled=!1;return}t.main_image_url=a,t.farmer_id=e;const{error:s}=await l.from("listings").insert(t);s?o(s.message,"error"):(o("Listing posted successfully!","success"),u.reset(),document.getElementById("image-preview-wrapper").innerHTML="",p(),f("listings-panel")),r.disabled=!1,r.textContent="Post Listing"}async function z(n,e,t){if(!M())return;r.disabled=!0,r.innerHTML='<span class="spinner"></span>Updating...';const i=S(),a=document.getElementById("product-image").files[0];if(a){const h=await T(a,e);h&&(i.main_image_url=h)}const{error:s}=await l.from("listings").update(i).eq("id",t);s?o(s.message,"error"):(o("Listing updated!","success"),setTimeout(()=>o(""),3e3)),r.disabled=!1,r.textContent="Update Listing"}function S(){return{category:document.getElementById("product-category").value,sub_category:document.getElementById("product-subcategory").value,product_name:document.getElementById("product-name").value,price:document.getElementById("product-price").value,quantity_available:document.getElementById("product-quantity").value,location:document.getElementById("product-location").value,description:document.getElementById("product-description").value}}function M(){const n=document.getElementById("product-category").value,e=document.getElementById("product-subcategory").value,t=parseFloat(document.getElementById("product-price").value);return n?e?isNaN(t)||t<=0?(o("Price must be valid.","error"),!1):!0:(o("Please select a Sub-Category.","error"),!1):(o("Please select a Category.","error"),!1)}async function T(n,e){o("Uploading image...","success");const t=`public/${e}_${Date.now()}_${n.name.replace(/[^a-zA-Z0-9.]/g,"")}`,{error:i}=await l.storage.from("product_images").upload(t,n);if(i)return o(`Upload failed: ${i.message}`,"error"),null;const{data:a}=l.storage.from("product_images").getPublicUrl(t);return a.publicUrl}async function E(n){if(!v)return;d.textContent="Loading listings...";const{data:e,error:t}=await l.from("listings").select("*").eq("farmer_id",n).order("created_at",{ascending:!1});t?d.textContent="Error loading.":(v.innerHTML="",e.length===0?(d.textContent="No listings yet.",d.style.display="block"):(d.style.display="none",e.forEach(i=>{const a=document.createElement("div");a.className="listing-card",a.innerHTML=`
          <div class="listing-card-content" style="padding:1rem;">
            <h4 style="margin:0 0 0.5rem 0; font-size:1rem; color:#666; text-transform:uppercase; font-size:0.8rem; font-weight:700;">
              ${i.category||"Produce"} - ${i.sub_category||"General"}
            </h4>
            <h3 style="margin:0 0 0.5rem 0;">${i.product_name}</h3>
            <p style="color:var(--primary-color); font-weight:700;">$${i.price}</p>
          </div>
          <div class="listing-card-actions" style="padding:0 1rem 1rem 1rem; display:flex; gap:0.5rem;">
            <a href="/dashboard.html?edit_id=${i.id}" class="btn edit-btn" style="flex:1; text-align:center;">Edit</a>
            <button class="btn delete-btn" data-id="${i.id}" style="flex:1;">Delete</button>
          </div>
        `,a.querySelector(".delete-btn").addEventListener("click",()=>N(i.id,n)),v.appendChild(a)})))}async function N(n,e){confirm("Delete this listing?")&&(await l.from("listings").delete().eq("id",n).eq("farmer_id",e),E(e))}function o(n,e){y&&(y.textContent=n,y.className=e)}function w(n,e){b&&(b.textContent=n,b.className=e)}function A(n){let e=n.replace(/\D/g,"");return e.startsWith("0")&&(e=e.substring(1)),e.startsWith("263")||(e="263"+e),"+"+e}export{q as initDashboardPage};
