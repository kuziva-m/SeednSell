import{s as b,C as v,g as Q,a as F}from"./app-BX46ysSj.js";import{handleStartChat as K}from"./chat-Ba-ruJlb.js";const k=document.getElementById("featured-listings-grid"),y=document.getElementById("featured-loading-message"),C=document.getElementById("listings-grid-content"),f=document.getElementById("loading-message"),g=document.getElementById("listing-detail-container"),G=document.getElementById("search-form"),M=document.getElementById("search-input"),U=document.getElementById("location-input"),s=document.getElementById("load-more-btn"),q=document.getElementById("breadcrumb-container");let h=0;const D=8;let _="",L="",d="produce",A=!0;const I={produce:{theme:"theme-produce",title:"Connect Directly with Farmers.",desc:"Fresh produce from the farm, straight to you. No middle-man.",btnText:"Browse Produce",unitDefault:"crate"},inputs:{theme:"theme-inputs",title:"Quality Farm Inputs & Seeds.",desc:"Find fertilizer, seeds, and chemicals from trusted suppliers near you.",btnText:"Browse Inputs",unitDefault:"bag"},services:{theme:"theme-services",title:"Hire Reliable Farm Services.",desc:"Tractors, transport, and veterinary services on demand.",btnText:"Find Services",unitDefault:"job"}};function Y(n,i){let e;return function(...t){clearTimeout(e),e=setTimeout(()=>n.apply(this,t),i)}}function W(n,i=4){n.innerHTML="";for(let e=0;e<i;e++){const t=document.createElement("div");t.className="listing-card skeleton-card",t.innerHTML=`
      <div class="skeleton skeleton-img"></div>
      <div class="skeleton-content">
        <div class="skeleton skeleton-text"></div>
        <div class="skeleton skeleton-text short"></div>
        <div class="skeleton skeleton-text price"></div>
      </div>
    `,n.appendChild(t)}}function R(n,i,e,t=null,a=null){n.innerHTML="";const o=document.createElement("div");if(o.className="empty-state fade-in-section is-visible",o.innerHTML=`
    <i class="fa-solid fa-basket-shopping"></i>
    <h3>${i}</h3>
    <p>${e}</p>
  `,t&&a){const r=document.createElement("button");r.className="btn btn-primary",r.textContent=t,r.onclick=a,o.appendChild(r)}n.appendChild(o)}async function Z(){if(!C)return;const i=new URLSearchParams(window.location.search).get("cat");i&&I[i]?d=i:d="produce",console.log(`Initializing listings for category: ${d}`),j(),J(),k&&O();const e=Y(()=>{const t=M.value.trim(),a=U.value;t===_&&a===L||(_=t,L=a,h=0,A=!0,s&&(s.style.display="none"),H(),k&&(k.innerHTML="",y&&(y.style.display="block",y.textContent="Searching bulk supply..."),O()))},350);M&&M.addEventListener("input",e),U&&U.addEventListener("change",e),G&&G.addEventListener("submit",t=>{t.preventDefault(),e()}),s&&s.addEventListener("click",()=>{h++,H()}),H()}function j(){const n=I[d];document.body.classList.remove("theme-produce","theme-inputs","theme-services"),n.theme&&document.body.classList.add(n.theme),document.querySelectorAll(".nav-pill").forEach(a=>{a.classList.remove("active"),a.href.includes(`cat=${d}`)&&a.classList.add("active")});const i=document.getElementById("hero-title"),e=document.getElementById("hero-desc"),t=document.getElementById("hero-browse-btn");i&&(i.textContent=n.title),e&&(e.textContent=n.desc),t&&(t.textContent=n.btnText)}async function J(){const n=document.getElementById("location-input");if(!n)return;const{data:i,error:e}=await b.rpc("get_distinct_locations");if(e){console.error("Error fetching locations:",e);return}n.innerHTML='<option value="">All Locations</option>',i.forEach(t=>{if(t.location&&t.location.trim()!==""){const a=document.createElement("option");a.value=t.location,a.textContent=t.location,n.appendChild(a)}})}async function H(){if(!A)return;s&&(s.disabled=!0),h===0?(f&&(f.style.display="none"),W(C,4)):s&&(s.textContent="Loading...");const n=h*D,i=n+D-1;let e=b.from("listings").select("*, profiles ( full_name )").neq("farmer_id",v.COMPANY_USER_ID).eq("category",d).order("created_at",{ascending:!1}).range(n,i);_&&(e=e.ilike("product_name",`%${_}%`)),L&&(e=e.eq("location",L));const{data:t,error:a}=await e;if(s&&(s.textContent="Load More",s.disabled=!1),a){h===0&&(C.innerHTML=""),f&&(f.textContent=`Error loading listings: ${a.message}`,f.style.display="block");return}if(h===0&&(C.innerHTML=""),t.length===0&&h===0){f&&(f.style.display="none"),R(C,`No ${d} found`,"We couldn't find exactly what you're looking for. Try a different search term or location.","Clear Filters",()=>{M.value="",U.value="",M.dispatchEvent(new Event("input"))}),s&&(s.style.display="none");return}t.length<D?(A=!1,s&&(s.style.display="none")):s&&(s.style.display="block"),z(t,C,null)}async function O(){let n=b.from("listings").select("*, profiles ( full_name )").eq("farmer_id",v.COMPANY_USER_ID).eq("category",d).order("created_at",{ascending:!1});_&&(n=n.ilike("product_name",`%${_}%`)),L&&(n=n.eq("location",L));const{data:i,error:e}=await n;e?y.textContent="Error loading featured listings.":i.length===0?(y&&(y.style.display="none"),R(k,"No featured items",`Our core company has no bulk ${d} contracts available right now.`)):z(i,k,y)}function z(n,i,e){e&&(e.style.display="none"),n.forEach(t=>{const a=document.createElement("article");a.className="listing-card fade-in-section is-visible";const o=document.createElement("a");o.href=`listing.html?id=${t.id}`,o.className="listing-card-link";const r=document.createElement("img");if(r.loading="lazy",r.decoding="async",t.main_image_url)try{const p=t.main_image_url.split(`/${v.IMAGES.BUCKET}/`)[1];if(p){const{data:x}=b.storage.from(v.IMAGES.BUCKET).getPublicUrl(p,{transform:{width:400,height:300,resize:"cover"}});r.src=x.publicUrl}else r.src=t.main_image_url}catch{r.src="/images/logo.webp"}else r.src="/images/logo.webp";r.alt=t.product_name;const u=document.createElement("div");u.className="listing-card-content";const w=document.createElement("h3");w.textContent=t.product_name;const T=document.createElement("p");T.className="price";const m=(I[d]||I.produce).unitDefault;T.textContent=`$${t.price} / ${m}`;const l=document.createElement("p");l.className="location";const E=document.createElement("i");E.className="fa-solid fa-location-dot";const $=document.createTextNode(` ${t.location}`);l.appendChild(E),l.appendChild($),u.appendChild(w),u.appendChild(T),u.appendChild(l),o.appendChild(r),o.appendChild(u),a.appendChild(o),i.appendChild(a)})}async function ee(){var a;if(!g)return;const i=new URLSearchParams(window.location.search).get("id");if(!i){g.innerHTML='<p class="error">Listing not found. <a href="index.html">Go home</a>.</p>';return}const{data:e,error:t}=await b.from("listings").select("*, profiles ( id, full_name )").eq("id",i).single();if(t){g.innerHTML='<p class="error">Error loading listing.</p>';return}if(e){document.title=`${e.product_name} - Seed & Sell`;const o=e.category||"produce",u=(I[o]||I.produce).unitDefault;q&&(q.innerHTML=`<a href="index.html?cat=${o}">Home</a> &gt; <a href="index.html?cat=${o}#marketplace-container">${o.charAt(0).toUpperCase()+o.slice(1)}</a> &gt; <span class="current">${e.product_name}</span>`);const w=F(),T=w&&w===e.farmer_id;g.innerHTML="";const S=document.createElement("div");S.className="listing-detail-image-wrapper";const m=document.createElement("img");if(m.id="listing-image",e.main_image_url)try{const c=e.main_image_url.split(`/${v.IMAGES.BUCKET}/`)[1];if(c){const{data:B}=b.storage.from(v.IMAGES.BUCKET).getPublicUrl(c,{transform:{width:800,height:600,resize:"cover"}});m.src=B.publicUrl}else m.src=e.main_image_url}catch{m.src="/images/logo.webp"}else m.src="/images/logo.webp";m.alt=e.product_name,S.appendChild(m);const l=document.createElement("div");l.className="listing-detail-info";const E=document.createElement("h2");E.id="listing-title",E.textContent=e.product_name;const $=document.createElement("p");$.id="listing-price",$.textContent=`$${e.price} / ${u}`;const p=document.createElement("div");p.className="listing-meta-group",p.innerHTML=`
      <p class="listing-meta-item"><i class="fa-solid fa-cubes"></i> <span><strong>Available:</strong> ${e.quantity_available||"Not specified"} ${u}s</span></p>
      <p class="listing-meta-item"><i class="fa-solid fa-location-dot"></i> <span><strong>Location:</strong> ${e.location}</span></p>
    `;const x=document.createElement("div");x.className="listing-description-card",x.innerHTML=`<h3>Description</h3><p>${e.description||"No description provided."}</p>`,l.appendChild(E),l.appendChild($),l.appendChild(p),l.appendChild(x);const P=document.createElement("div");P.className="listing-detail-sidebar";const N=document.createElement("div");if(N.className="farmer-details-card",N.innerHTML=`<h3>Seller Details</h3><p class="listing-meta-item"><i class="fa-solid fa-user"></i> <span><strong>Contact:</strong> ${((a=e.profiles)==null?void 0:a.full_name)||"Unknown"}</span></p>`,T){const c=document.createElement("a");c.href=`/dashboard.html?edit_id=${e.id}`,c.className="btn btn-primary btn-full-width",c.textContent="Edit Your Listing",N.appendChild(c)}else{const c=document.createElement("button");c.className="btn btn-primary btn-full-width",c.textContent="Chat with Seller",c.onclick=()=>{const B=Q();if(!B)return alert("Please log in as a Buyer to chat.");if(B.user_role==="farmer"&&o==="produce")return alert("Farmers cannot chat with other farmers.");K(e.profiles.id,F())},N.appendChild(c)}P.appendChild(N),g.appendChild(S),g.appendChild(l),g.appendChild(P)}}export{ee as initListingDetailPage,Z as initListingsPage};
