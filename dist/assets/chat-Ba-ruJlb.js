import{b as p,s as m,a as E,c as _}from"./app-BX46ysSj.js";const u=document.getElementById("room-list"),b=document.getElementById("chat-header"),c=document.getElementById("chat-messages"),l=document.getElementById("chat-input-form"),f=document.getElementById("message-input");let g=null,y=null;async function H(e,t){const{data:a}=await m.from("chat_rooms").select("id").eq("buyer_id",t).eq("farmer_id",e).single();if(a)window.location.href=`/messages.html?room_id=${a.id}`;else{const{data:n,error:s}=await m.from("chat_rooms").insert({buyer_id:t,farmer_id:e}).select("id").single();s?alert("Error starting chat."):window.location.href=`/messages.html?room_id=${n.id}`}}function S(){const e=E();if(!e){setTimeout(S,200);return}if(p(),l){const t=l.querySelector("button");t&&(t.innerHTML='<i class="fa-solid fa-paper-plane"></i>'),l.addEventListener("submit",a=>C(a,e))}v(e)}async function v(e){if(!u)return;const t=await _(),{data:a,error:n}=await m.from("chat_rooms").select("id, buyer_id, farmer_id, buyer:buyer_id ( full_name ), farmer:farmer_id ( full_name )").or(`buyer_id.eq.${e},farmer_id.eq.${e}`);if(n){u.innerHTML="<p style='padding:1rem'>Error loading conversations.</p>";return}if(a.length===0){u.innerHTML="<p style='padding:1rem'>No conversations yet.</p>",b&&(b.innerHTML=""),c&&(c.innerHTML=`
      <div class="chat-empty-state">
        <i class="fa-solid fa-comments"></i>
        <p>No messages selected</p>
        <span>Select a conversation to start chatting.</span>
      </div>
    `),l&&(l.style.display="none");return}l&&(l.style.display="flex"),u.innerHTML="",a.forEach(o=>{const i=e===o.buyer_id?o.farmer.full_name:o.buyer.full_name,d=document.createElement("div");if(d.className="room-item",d.appendChild(document.createTextNode(i)),d.dataset.roomId=o.id,d.dataset.roomName=i,t&&t[o.id]){const h=document.createElement("span");h.className="room-notification-bubble",h.textContent=t[o.id],d.appendChild(h)}d.addEventListener("click",()=>{document.querySelector(".chat-container").classList.add("chat-active"),T(o.id,i,e)}),u.appendChild(d)});const r=new URLSearchParams(window.location.search).get("room_id");if(r){const o=document.querySelector(`.room-item[data-room-id="${r}"]`);o&&o.click()}}async function T(e,t,a){g=e,y=null;const n=`/messages.html?room_id=${e}`;window.history.pushState({path:n},"",n);const s=document.querySelector(`.room-item[data-room-id="${e}"]`);if(s){s.classList.add("active-room");const i=s.querySelector(".room-notification-bubble");i&&(i.style.display="none")}document.querySelectorAll(".room-item").forEach(i=>{i!==s&&i.classList.remove("active-room")}),b.innerHTML=`
    <button id="chat-back-btn" class="chat-back-btn">
      <i class="fa-solid fa-arrow-left"></i>
    </button>
    <p>${t}</p>
  `,document.getElementById("chat-back-btn").addEventListener("click",()=>{document.querySelector(".chat-container").classList.remove("chat-active"),g=null,p(),window.history.pushState({path:"/messages.html"},"","/messages.html")}),c.innerHTML="<p style='padding:2rem; text-align:center;'>Loading messages...</p>",await m.from("chat_messages").update({is_read:!0}).eq("room_id",e).neq("sender_id",a),await _();const{data:r,error:o}=await m.from("chat_messages").select("*").eq("room_id",e).order("created_at");if(o){c.innerHTML="<p>Error loading messages.</p>";return}c.innerHTML="",r.forEach(i=>{w(i,a)}),L(),p()}function w(e,t){const a=D(e.created_at);if(a){const o=document.createElement("div");o.className="date-header",o.textContent=a,c.appendChild(o)}const n=document.createElement("div");n.id=`msg-${e.id}`,n.className="message-bubble",n.classList.add(e.sender_id===t?"sender":"receiver");const s=document.createElement("span");s.textContent=e.message_content;const r=document.createElement("span");r.className="message-time",r.textContent=M(e.created_at),n.appendChild(s),n.appendChild(r),c.appendChild(n)}function L(){c.scrollTop=c.scrollHeight}async function C(e,t){if(e.preventDefault(),!g)return;const a=f.value.trim();if(a.length===0)return;f.disabled=!0;const n=`temp-${Date.now()}`,s={id:n,sender_id:t,message_content:a,created_at:new Date().toISOString()};w(s,t),L(),f.value="";const{data:r,error:o}=await m.from("chat_messages").insert({room_id:g,sender_id:t,message_content:a}).select().single();if(o)console.error("Error sending:",o.message);else{const i=document.getElementById(`msg-${n}`);i&&(i.id=`msg-${r.id}`)}f.disabled=!1,f.focus()}function M(e){return new Date(e).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})}function D(e){const t=new Date(e),a=new Date,n=new Date(a);n.setDate(n.getDate()-1);const s=t.toLocaleDateString();return y===s?null:(y=s,s===a.toLocaleDateString()?"Today":s===n.toLocaleDateString()?"Yesterday":t.toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"}))}export{H as handleStartChat,S as initChatPage};
