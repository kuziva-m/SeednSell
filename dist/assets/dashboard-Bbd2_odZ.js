import{a as x,s as u}from"./app-CcbB4Lsu.js";const v=document.getElementById("listing-form"),L=document.getElementById("listing-message"),s=document.getElementById("submit-listing-btn"),w=document.getElementById("my-listings-grid"),y=document.getElementById("my-listings-loading"),E=document.getElementById("product-category"),b=document.getElementById("product-subcategory"),S=document.getElementById("quantity-label"),P=document.querySelectorAll(".dashboard-nav-link"),U=document.querySelectorAll(".dashboard-panel"),M=document.getElementById("profile-form"),C=document.getElementById("profile-message"),h=document.getElementById("profile-submit-btn");let l=null;const D={produce:{label:"Farm Produce",unit:"Quantity (Crates, Buckets, Tons)",types:["Maize","Tomatoes","Onions","Leafy Vegetables (Covo/Rape)","Potatoes","Poultry (Road Runners/Broilers)","Beef/Livestock","Goats","Eggs","Mushrooms","Soya Beans","Tobacco"]},inputs:{label:"Farm Inputs",unit:"Quantity (Bags, Litres, KGs)",types:["Maize Seed (Short Season)","Maize Seed (Long Season)","Fertilizer (Compound D)","Fertilizer (AN)","Fertilizer (Super D)","Lime","Herbicides","Pesticides","Stockfeed","Veterinary Medicine"]},services:{label:"Services",unit:"Availability (Hours, Hectares, Trips)",types:["Tractor Ploughing","Crop Spraying","Transport/Logistics","Borehole Drilling","Harvesting","Veterinary Services","Farm Fencing","Consultancy/Agronomy"]}};function H(){const n=x();if(!n){setTimeout(()=>{x()&&H()},500);return}const t=document.querySelector(".dashboard-layout");t&&t.classList.add("is-ready");const e=document.getElementById("verification-banner");e&&(e.style.display="block"),k(),z(n),T(n);const i=document.getElementById("profile-phone");i&&window.intlTelInput&&!l&&(l=window.intlTelInput(i,{initialCountry:"zw",preferredCountries:["zw","za"],separateDialCode:!0,utilsScript:"https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/utils.js"}));const a=document.getElementById("dashboard-logout-btn");a&&a.addEventListener("click",c=>{c.preventDefault();const m=document.getElementById("logout-modal");m&&m.classList.add("is-visible")}),E&&E.addEventListener("change",B),M&&M.addEventListener("submit",c=>$(c,n)),v&&v.addEventListener("submit",c=>G(c,n));const o=document.getElementById("product-image");o&&o.addEventListener("change",R);const d=new URLSearchParams(window.location.search).get("edit_id");d?(A(d,n),I("form-panel")):I("profile-panel")}function B(){const n=E.value,t=D[n];t&&S&&(S.textContent=t.unit),b.innerHTML='<option value="" disabled selected>-- Select Type --</option>',t?(b.disabled=!1,t.types.forEach(e=>{const i=document.createElement("option");i.value=e,i.textContent=e,b.appendChild(i)})):b.disabled=!0}function k(){P.forEach(n=>{n.id!=="dashboard-logout-btn"&&n.addEventListener("click",t=>{t.preventDefault();const e=n.dataset.panel;I(e)})})}function I(n){U.forEach(i=>i.classList.remove("active")),P.forEach(i=>i.classList.remove("active"));const t=document.getElementById(n);t&&t.classList.add("active");const e=document.querySelector('.dashboard-nav-link[data-panel="'.concat(n,'"]'));e&&(e.classList.add("active"),window.location.hash=e.hash)}async function z(n){const{data:t}=await u.from("profiles").select("full_name, phone_number, location").eq("id",n).single();t&&(document.getElementById("profile-name").value=t.full_name,l?l.setNumber(t.phone_number):document.getElementById("profile-phone").value=t.phone_number,document.getElementById("profile-location").value=t.location)}async function $(n,t){if(n.preventDefault(),l&&!l.isValidNumber()){_("Invalid phone number.","error");return}h.disabled=!0,h.innerHTML='<span class="spinner"></span>Updating...';const e=document.getElementById("profile-name").value,i=l?l.getNumber():document.getElementById("profile-phone").value,a=document.getElementById("profile-location").value,{error:o}=await u.from("profiles").update({full_name:e,phone_number:i,location:a}).eq("id",t);o?_("Error: ".concat(o.message),"error"):(_("Profile updated!","success"),l&&l.setNumber(i)),h.disabled=!1,h.innerHTML="Update Profile"}async function A(n,t){r("Loading listing...","success");const{data:e,error:i}=await u.from("listings").select("*").eq("id",n).eq("farmer_id",t).single();if(i||!e){r("Error loading listing.","error");return}document.getElementById("listing-id").value=e.id,document.getElementById("product-name").value=e.product_name,document.getElementById("product-price").value=e.price,document.getElementById("product-quantity").value=e.quantity_available,document.getElementById("product-location").value=e.location,document.getElementById("product-description").value=e.description,e.category&&D[e.category]?(E.value=e.category,B(),e.sub_category&&(b.value=e.sub_category)):(E.value="produce",B()),document.getElementById("form-title").innerHTML='<i class="fa-solid fa-pen-to-square icon"></i> Edit Listing',s.textContent="Update Listing";let a=document.getElementById("image-preview-wrapper");a||(a=document.createElement("div"),a.id="image-preview-wrapper",v.insertBefore(a,s)),a.innerHTML='<img src="'.concat(e.main_image_url,'" alt="Current image">'),r("Loaded. Make changes and Update.","success")}function R(n){const t=n.target.files[0];let e=document.getElementById("image-preview-wrapper");if(e||(e=document.createElement("div"),e.id="image-preview-wrapper",v.insertBefore(e,s)),e.innerHTML="",t){const i=new FileReader;i.onload=a=>{const o=document.createElement("img");o.src=a.target.result,e.appendChild(o)},i.readAsDataURL(t)}}async function G(n,t){n.preventDefault();const e=document.getElementById("listing-id").value;e?await j(n,t,e):await V(n,t),T(t)}async function V(n,t){if(!F())return;s.disabled=!0,s.innerHTML='<span class="spinner"></span>Uploading...';const e=q(),i=document.getElementById("product-image").files[0];if(!i){r("Image required.","error"),s.disabled=!1;return}const a=await N(i,t);if(!a){s.disabled=!1;return}e.main_image_url=a,e.farmer_id=t;const{error:o}=await u.from("listings").insert(e);o?r(o.message,"error"):(r("Listing posted successfully!","success"),v.reset(),document.getElementById("image-preview-wrapper").innerHTML="",B(),I("listings-panel")),s.disabled=!1,s.textContent="Post Listing"}async function j(n,t,e){if(!F())return;s.disabled=!0,s.innerHTML='<span class="spinner"></span>Updating...';const i=q(),a=document.getElementById("product-image").files[0];if(a){const d=await N(a,t);d&&(i.main_image_url=d)}const{error:o}=await u.from("listings").update(i).eq("id",e);o?r(o.message,"error"):(r("Listing updated!","success"),setTimeout(()=>r(""),3e3)),s.disabled=!1,s.textContent="Update Listing"}function q(){return{category:document.getElementById("product-category").value,sub_category:document.getElementById("product-subcategory").value,product_name:document.getElementById("product-name").value,price:document.getElementById("product-price").value,quantity_available:document.getElementById("product-quantity").value,location:document.getElementById("product-location").value,description:document.getElementById("product-description").value}}function F(){const n=document.getElementById("product-category").value,t=document.getElementById("product-subcategory").value,e=parseFloat(document.getElementById("product-price").value);return n?t?isNaN(e)||e<=0?(r("Price must be valid.","error"),!1):!0:(r("Please select a Sub-Category.","error"),!1):(r("Please select a Category.","error"),!1)}async function N(n,t){r("Uploading image...","success");const e="public/".concat(t,"_").concat(Date.now(),"_").concat(n.name.replace(/[^a-zA-Z0-9.]/g,"")),{error:i}=await u.storage.from("product_images").upload(e,n);if(i)return r("Upload failed: ".concat(i.message),"error"),null;const{data:a}=u.storage.from("product_images").getPublicUrl(e);return a.publicUrl}async function T(n){if(!w)return;y.textContent="Loading listings...";const{data:t,error:e}=await u.from("listings").select("*").eq("farmer_id",n).order("created_at",{ascending:!1});e?y.textContent="Error loading.":(w.innerHTML="",t.length===0?(y.textContent="No listings yet.",y.style.display="block"):(y.style.display="none",t.forEach(i=>{const a=document.createElement("div");a.className="listing-card";const o=document.createElement("div");o.className="listing-card-content",o.style.padding="1rem";const d=document.createElement("h4");d.style.cssText="margin:0 0 0.5rem 0; font-size:1rem; color:#666; text-transform:uppercase; font-size:0.8rem; font-weight:700;",d.textContent="".concat(i.category||"Produce"," - ").concat(i.sub_category||"General");const c=document.createElement("h3");c.style.margin="0 0 0.5rem 0",c.textContent=i.product_name;const m=document.createElement("p");m.style.cssText="color:var(--primary-color); font-weight:700;",m.textContent="$".concat(i.price),o.appendChild(d),o.appendChild(c),o.appendChild(m);const p=document.createElement("div");p.className="listing-card-actions",p.style.cssText="padding:0 1rem 1rem 1rem; display:flex; gap:0.5rem;";const f=document.createElement("a");f.href="/dashboard.html?edit_id=".concat(i.id),f.className="btn edit-btn",f.style.cssText="flex:1; text-align:center;",f.textContent="Edit";const g=document.createElement("button");g.className="btn delete-btn",g.dataset.id=i.id,g.style.flex="1",g.textContent="Delete",g.addEventListener("click",()=>O(i.id,n)),p.appendChild(f),p.appendChild(g),a.appendChild(o),a.appendChild(p),w.appendChild(a)})))}async function O(n,t){confirm("Delete this listing?")&&(await u.from("listings").delete().eq("id",n).eq("farmer_id",t),T(t))}function r(n,t){L&&(L.textContent=n,L.className=t)}function _(n,t){C&&(C.textContent=n,C.className=t)}export{H as initDashboardPage};
