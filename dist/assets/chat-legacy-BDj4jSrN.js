System.register(["./app-legacy-CZVEl_fd.js"],function(e,t){"use strict";var n,a,o,s;return{setters:[e=>{n=e.b,a=e.s,o=e.a,s=e.c}],execute:function(){e({handleStartChat:async function(e,t){const{data:n}=await a.from("chat_rooms").select("id").eq("buyer_id",t).eq("farmer_id",e).single();if(n)window.location.href=`/messages.html?room_id=${n.id}`;else{const{data:n,error:o}=await a.from("chat_rooms").insert({buyer_id:t,farmer_id:e}).select("id").single();o?alert("Error starting chat."):window.location.href=`/messages.html?room_id=${n.id}`}},initChatPage:function e(){const g=o();if(g){if(n(),c){const e=c.querySelector("button");e&&(e.innerHTML='<i class="fa-solid fa-paper-plane"></i>'),c.addEventListener("submit",e=>async function(e,t){if(e.preventDefault(),!m)return;const n=d.value.trim();if(0===n.length)return;d.disabled=!0;const o=`temp-${Date.now()}`,s={id:o,sender_id:t,message_content:n,created_at:(new Date).toISOString()};u(s,t),f(),d.value="";const{data:r,error:i}=await a.from("chat_messages").insert({room_id:m,sender_id:t,message_content:n}).select().single();if(i)console.error("Error sending:",i.message);else{const e=document.getElementById(`msg-${o}`);e&&(e.id=`msg-${r.id}`)}d.disabled=!1,d.focus()}(e,g))}!async function(e){if(!t)return;const o=await s(),{data:d,error:g}=await a.from("chat_rooms").select("id, buyer_id, farmer_id, buyer:buyer_id ( full_name ), farmer:farmer_id ( full_name )").or(`buyer_id.eq.${e},farmer_id.eq.${e}`);if(g)return void(t.innerHTML="<p style='padding:1rem'>Error loading conversations.</p>");if(0===d.length)return t.innerHTML="<p style='padding:1rem'>No conversations yet.</p>",r&&(r.textContent=""),i&&(i.innerHTML='\n      <div class="chat-empty-state">\n        <i class="fa-solid fa-comments"></i>\n        <p>No messages selected</p>\n        <span>Select a conversation to start chatting.</span>\n      </div>\n    '),void(c&&(c.style.display="none"));c&&(c.style.display="flex"),t.innerHTML="",d.forEach(c=>{const d=e===c.buyer_id?c.farmer.full_name:c.buyer.full_name,g=document.createElement("div");if(g.className="room-item",g.appendChild(document.createTextNode(d)),g.dataset.roomId=c.id,g.dataset.roomName=d,o&&o[c.id]){const e=document.createElement("span");e.className="room-notification-bubble",e.textContent=o[c.id],g.appendChild(e)}g.addEventListener("click",()=>{document.querySelector(".chat-container").classList.add("chat-active"),async function(e,t,o){m=e,l=null;const c=`/messages.html?room_id=${e}`;window.history.pushState({path:c},"",c);const d=document.querySelector(`.room-item[data-room-id="${e}"]`);if(d){d.classList.add("active-room");const e=d.querySelector(".room-notification-bubble");e&&(e.style.display="none")}document.querySelectorAll(".room-item").forEach(e=>{e!==d&&e.classList.remove("active-room")}),r.innerHTML="";const g=document.createElement("button");g.id="chat-back-btn",g.className="chat-back-btn",g.innerHTML='<i class="fa-solid fa-arrow-left"></i>',g.addEventListener("click",()=>{document.querySelector(".chat-container").classList.remove("chat-active"),m=null,n(),window.history.pushState({path:"/messages.html"},"","/messages.html")});const p=document.createElement("p");p.textContent=t,r.appendChild(g),r.appendChild(p),i.innerHTML="<p style='padding:2rem; text-align:center;'>Loading messages...</p>",await a.from("chat_messages").update({is_read:!0}).eq("room_id",e).neq("sender_id",o),await s();const{data:h,error:y}=await a.from("chat_messages").select("*").eq("room_id",e).order("created_at");y?i.innerHTML="<p>Error loading messages.</p>":(i.innerHTML="",h.forEach(e=>{u(e,o)}),f(),n())}(c.id,d,e)}),t.appendChild(g)});const p=new URLSearchParams(window.location.search).get("room_id");if(p){const e=document.querySelector(`.room-item[data-room-id="${p}"]`);e&&e.click()}}(g)}else setTimeout(e,200)}});const t=document.getElementById("room-list"),r=document.getElementById("chat-header"),i=document.getElementById("chat-messages"),c=document.getElementById("chat-input-form"),d=document.getElementById("message-input");let m=null,l=null;function u(e,t){const n=function(e){const t=new Date(e),n=new Date,a=new Date(n);a.setDate(a.getDate()-1);const o=t.toLocaleDateString();return l===o?null:(l=o,o===n.toLocaleDateString()?"Today":o===a.toLocaleDateString()?"Yesterday":t.toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"}))}(e.created_at);if(n){const e=document.createElement("div");e.className="date-header",e.textContent=n,i.appendChild(e)}const a=document.createElement("div");a.id=`msg-${e.id}`,a.className="message-bubble",a.classList.add(e.sender_id===t?"sender":"receiver");const o=document.createElement("span");o.textContent=e.message_content;const s=document.createElement("span");var r;s.className="message-time",s.textContent=(r=e.created_at,new Date(r).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})),a.appendChild(o),a.appendChild(s),i.appendChild(a)}function f(){i.scrollTop=i.scrollHeight}}}});
