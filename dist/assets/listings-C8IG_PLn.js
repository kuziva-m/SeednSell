import{s as I,C as _,g as z,a as F}from"./app-7r4lVeY4.js";import{handleStartChat as Q}from"./chat-BnpMGAHT.js";const $=document.getElementById("featured-listings-grid"),C=document.getElementById("featured-loading-message"),L=document.getElementById("listings-grid-content"),y=document.getElementById("loading-message"),b=document.getElementById("listing-detail-container"),G=document.getElementById("search-form"),N=document.getElementById("search-input"),D=document.getElementById("location-input"),s=document.getElementById("load-more-btn"),q=document.getElementById("breadcrumb-container");let E=0;const H=8;let T="",w="",m="produce",A=!0;const x={produce:{theme:"theme-produce",title:"Connect Directly with Farmers.",desc:"Fresh produce from the farm, straight to you. No middle-man.",btnText:"Browse Produce",unitDefault:"crate",promo:{bgImage:"/images/field.webp",left:{title:'<i class="fa-solid fa-truck-ramp-box icon"></i>Are You a Large-Scale Buyer?',desc:"Need a reliable, large-volume supply of produce? Our core company offers bulk contracts for supermarkets and exporters.",btn:"Contact Sales"},right:{title:'<i class="fa-solid fa-tractor icon"></i>Are You a Farmer?',desc:"Tired of finding buyers? Join our Contract Program. We supply the seed and guarantee to buy 100% of your harvest.",btn:"Join Our Program"}}},inputs:{theme:"theme-inputs",title:"Quality Farm Inputs & Seeds.",desc:"Find fertilizer, seeds, and chemicals from trusted suppliers near you.",btnText:"Browse Inputs",unitDefault:"bag",promo:{bgImage:"/images/promo-inputs.jpg",left:{title:'<i class="fa-solid fa-shop icon"></i>Looking for Bulk Inputs?',desc:"We supply large-scale commercial farms with fertilizer, chemicals, and seed at wholesale prices.",btn:"Get a Quote"},right:{title:'<i class="fa-solid fa-hand-holding-dollar icon"></i>Are You a Supplier?',desc:"Expand your customer base. List your agro-chemicals and seeds directly to thousands of farmers.",btn:"Start Selling Inputs"}}},services:{theme:"theme-services",title:"Hire Reliable Farm Services.",desc:"Tractors, transport, and veterinary services on demand.",btnText:"Find Services",unitDefault:"job",promo:{bgImage:"/images/promo-services.jpg",left:{title:'<i class="fa-solid fa-clipboard-list icon"></i>Need Contract Work Done?',desc:"From ploughing to harvesting, find reliable service providers with verified ratings.",btn:"Post a Job"},right:{title:'<i class="fa-solid fa-wrench icon"></i>Own a Tractor or Truck?',desc:"Don't let your machinery sit idle. List your services and get hired by farmers in your area.",btn:"List Your Service"}}}};function W(t,i){let e;return function(...n){clearTimeout(e),e=setTimeout(()=>t.apply(this,n),i)}}function K(t,i=4){t.innerHTML="";for(let e=0;e<i;e++){const n=document.createElement("div");n.className="listing-card skeleton-card",n.innerHTML=`
      <div class="skeleton skeleton-img"></div>
      <div class="skeleton-content">
        <div class="skeleton skeleton-text"></div>
        <div class="skeleton skeleton-text short"></div>
        <div class="skeleton skeleton-text price"></div>
      </div>
    `,t.appendChild(n)}}function Y(t,i,e,n=null,a=null){t.innerHTML="";const o=document.createElement("div");if(o.className="empty-state fade-in-section is-visible",o.innerHTML=`
    <i class="fa-solid fa-basket-shopping"></i>
    <h3>${i}</h3>
    <p>${e}</p>
  `,n&&a){const r=document.createElement("button");r.className="btn btn-primary",r.textContent=n,r.onclick=a,o.appendChild(r)}t.appendChild(o)}async function Z(){if(!L)return;const i=new URLSearchParams(window.location.search).get("cat");i&&x[i]?m=i:m="produce",console.log(`Initializing listings for category: ${m}`),j(),J(),$&&O();const e=W(()=>{const n=N.value.trim(),a=D.value;n===T&&a===w||(T=n,w=a,E=0,A=!0,s&&(s.style.display="none"),U(),$&&($.innerHTML="",C&&(C.style.display="block",C.textContent="Searching bulk supply..."),O()))},350);N&&N.addEventListener("input",e),D&&D.addEventListener("change",e),G&&G.addEventListener("submit",n=>{n.preventDefault(),e()}),s&&s.addEventListener("click",()=>{E++,U()}),U()}function j(){const t=x[m];document.body.classList.remove("theme-produce","theme-inputs","theme-services"),t.theme&&document.body.classList.add(t.theme),document.querySelectorAll(".nav-pill").forEach(o=>{o.classList.remove("active"),o.href.includes(`cat=${m}`)&&o.classList.add("active")});const i=document.getElementById("hero-title"),e=document.getElementById("hero-desc"),n=document.getElementById("hero-browse-btn");i&&(i.textContent=t.title),e&&(e.textContent=t.desc),n&&(n.textContent=t.btnText);const a=document.getElementById("promo-section");if(a&&t.promo){a.style.backgroundImage=`url('${t.promo.bgImage}')`;const o=document.getElementById("promo-left-title"),r=document.getElementById("promo-left-desc"),l=document.getElementById("promo-left-btn");o&&(o.innerHTML=t.promo.left.title),r&&(r.textContent=t.promo.left.desc),l&&(l.textContent=t.promo.left.btn);const p=document.getElementById("promo-right-title"),f=document.getElementById("promo-right-desc"),g=document.getElementById("promo-right-btn");p&&(p.innerHTML=t.promo.right.title),f&&(f.textContent=t.promo.right.desc),g&&(g.textContent=t.promo.right.btn)}}async function J(){const t=document.getElementById("location-input");if(!t)return;const{data:i,error:e}=await I.rpc("get_distinct_locations");if(e){console.error("Error fetching locations:",e);return}t.innerHTML='<option value="">All Locations</option>',i.forEach(n=>{if(n.location&&n.location.trim()!==""){const a=document.createElement("option");a.value=n.location,a.textContent=n.location,t.appendChild(a)}})}async function U(){if(!A)return;s&&(s.disabled=!0),E===0?(y&&(y.style.display="none"),K(L,4)):s&&(s.textContent="Loading...");const t=E*H,i=t+H-1;let e=I.from("listings").select("*, profiles ( full_name )").neq("farmer_id",_.COMPANY_USER_ID).eq("category",m).order("created_at",{ascending:!1}).range(t,i);T&&(e=e.ilike("product_name",`%${T}%`)),w&&(e=e.eq("location",w));const{data:n,error:a}=await e;if(s&&(s.textContent="Load More",s.disabled=!1),a){E===0&&(L.innerHTML=""),y&&(y.textContent=`Error loading listings: ${a.message}`,y.style.display="block");return}if(E===0&&(L.innerHTML=""),n.length===0&&E===0){y&&(y.style.display="none"),Y(L,`No ${m} found`,"We couldn't find exactly what you're looking for. Try a different search term or location.","Clear Filters",()=>{N.value="",D.value="",N.dispatchEvent(new Event("input"))}),s&&(s.style.display="none");return}n.length<H?(A=!1,s&&(s.style.display="none")):s&&(s.style.display="block"),R(n,L,null)}async function O(){let t=I.from("listings").select("*, profiles ( full_name )").eq("farmer_id",_.COMPANY_USER_ID).eq("category",m).order("created_at",{ascending:!1});T&&(t=t.ilike("product_name",`%${T}%`)),w&&(t=t.eq("location",w));const{data:i,error:e}=await t;e?C.textContent="Error loading featured listings.":i.length===0?(C&&(C.style.display="none"),Y($,"No featured items",`Our core company has no bulk ${m} contracts available right now.`)):R(i,$,C)}function R(t,i,e){e&&(e.style.display="none"),t.forEach(n=>{const a=document.createElement("article");a.className="listing-card fade-in-section is-visible";const o=document.createElement("a");o.href=`listing.html?id=${n.id}`,o.className="listing-card-link";const r=document.createElement("img");if(r.loading="lazy",r.decoding="async",n.main_image_url)try{const h=n.main_image_url.split(`/${_.IMAGES.BUCKET}/`)[1];if(h){const{data:k}=I.storage.from(_.IMAGES.BUCKET).getPublicUrl(h,{transform:{width:400,height:300,resize:"cover"}});r.src=k.publicUrl}else r.src=n.main_image_url}catch{r.src="/images/logo.webp"}else r.src="/images/logo.webp";r.alt=n.product_name;const l=document.createElement("div");l.className="listing-card-content";const p=document.createElement("h3");p.textContent=n.product_name;const f=document.createElement("p");f.className="price";const u=(x[m]||x.produce).unitDefault;f.textContent=`$${n.price} / ${u}`;const d=document.createElement("p");d.className="location";const v=document.createElement("i");v.className="fa-solid fa-location-dot";const B=document.createTextNode(` ${n.location}`);d.appendChild(v),d.appendChild(B),l.appendChild(p),l.appendChild(f),l.appendChild(d),o.appendChild(r),o.appendChild(l),a.appendChild(o),i.appendChild(a)})}async function ee(){var a;if(!b)return;const i=new URLSearchParams(window.location.search).get("id");if(!i){b.innerHTML='<p class="error">Listing not found. <a href="index.html">Go home</a>.</p>';return}const{data:e,error:n}=await I.from("listings").select("*, profiles ( id, full_name )").eq("id",i).single();if(n){b.innerHTML='<p class="error">Error loading listing.</p>';return}if(e){document.title=`${e.product_name} - Seed & Sell`;const o=e.category||"produce",l=(x[o]||x.produce).unitDefault;q&&(q.innerHTML=`<a href="index.html?cat=${o}">Home</a> &gt; <a href="index.html?cat=${o}#marketplace-container">${o.charAt(0).toUpperCase()+o.slice(1)}</a> &gt; <span class="current">${e.product_name}</span>`);const p=F(),f=p&&p===e.farmer_id;b.innerHTML="";const g=document.createElement("div");g.className="listing-detail-image-wrapper";const u=document.createElement("img");if(u.id="listing-image",e.main_image_url)try{const c=e.main_image_url.split(`/${_.IMAGES.BUCKET}/`)[1];if(c){const{data:M}=I.storage.from(_.IMAGES.BUCKET).getPublicUrl(c,{transform:{width:800,height:600,resize:"cover"}});u.src=M.publicUrl}else u.src=e.main_image_url}catch{u.src="/images/logo.webp"}else u.src="/images/logo.webp";u.alt=e.product_name,g.appendChild(u);const d=document.createElement("div");d.className="listing-detail-info";const v=document.createElement("h2");v.id="listing-title",v.textContent=e.product_name;const B=document.createElement("p");B.id="listing-price",B.textContent=`$${e.price} / ${l}`;const h=document.createElement("div");h.className="listing-meta-group",h.innerHTML=`
      <p class="listing-meta-item"><i class="fa-solid fa-cubes"></i> <span><strong>Available:</strong> ${e.quantity_available||"Not specified"} ${l}s</span></p>
      <p class="listing-meta-item"><i class="fa-solid fa-location-dot"></i> <span><strong>Location:</strong> ${e.location}</span></p>
    `;const k=document.createElement("div");k.className="listing-description-card",k.innerHTML=`<h3>Description</h3><p>${e.description||"No description provided."}</p>`,d.appendChild(v),d.appendChild(B),d.appendChild(h),d.appendChild(k);const P=document.createElement("div");P.className="listing-detail-sidebar";const S=document.createElement("div");if(S.className="farmer-details-card",S.innerHTML=`<h3>Seller Details</h3><p class="listing-meta-item"><i class="fa-solid fa-user"></i> <span><strong>Contact:</strong> ${((a=e.profiles)==null?void 0:a.full_name)||"Unknown"}</span></p>`,f){const c=document.createElement("a");c.href=`/dashboard.html?edit_id=${e.id}`,c.className="btn btn-primary btn-full-width",c.textContent="Edit Your Listing",S.appendChild(c)}else{const c=document.createElement("button");c.className="btn btn-primary btn-full-width",c.textContent="Chat with Seller",c.onclick=()=>{const M=z();if(!M)return alert("Please log in as a Buyer to chat.");if(M.user_role==="farmer"&&o==="produce")return alert("Farmers cannot chat with other farmers.");Q(e.profiles.id,F())},S.appendChild(c)}P.appendChild(S),b.appendChild(g),b.appendChild(d),b.appendChild(P)}}export{ee as initListingDetailPage,Z as initListingsPage};
