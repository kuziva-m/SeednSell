import{a as q,s as l}from"./app-Bv5i1KIP.js";const m=document.getElementById("listing-form"),v=document.getElementById("listing-message"),r=document.getElementById("submit-listing-btn"),b=document.getElementById("my-listings-grid"),c=document.getElementById("my-listings-loading"),g=document.getElementById("product-category"),u=document.getElementById("product-subcategory"),L=document.getElementById("quantity-label"),C=document.querySelectorAll(".dashboard-nav-link"),D=document.querySelectorAll(".dashboard-panel"),I=document.getElementById("profile-form"),E=document.getElementById("profile-message"),p=document.getElementById("profile-submit-btn"),S={produce:{label:"Farm Produce",unit:"Quantity (Crates, Buckets, Tons)",types:["Maize","Tomatoes","Onions","Leafy Vegetables (Covo/Rape)","Potatoes","Poultry (Road Runners/Broilers)","Beef/Livestock","Goats","Eggs","Mushrooms","Soya Beans","Tobacco"]},inputs:{label:"Farm Inputs",unit:"Quantity (Bags, Litres, KGs)",types:["Maize Seed (Short Season)","Maize Seed (Long Season)","Fertilizer (Compound D)","Fertilizer (AN)","Fertilizer (Super D)","Lime","Herbicides","Pesticides","Stockfeed","Veterinary Medicine"]},services:{label:"Services",unit:"Availability (Hours, Hectares, Trips)",types:["Tractor Ploughing","Crop Spraying","Transport/Logistics","Borehole Drilling","Harvesting","Veterinary Services","Farm Fencing","Consultancy/Agronomy"]}};function V(){const n=q();n?w(n):document.addEventListener("auth:resolved",e=>{w(e.detail.userId)},{once:!0})}function w(n){const e=document.querySelector(".dashboard-layout");e&&e.classList.add("is-ready");const t=document.getElementById("verification-banner");t&&(t.style.display="block"),x(),F(n),h(n);const a=document.getElementById("dashboard-logout-btn");a&&a.addEventListener("click",d=>{d.preventDefault();const B=document.getElementById("logout-modal");B&&B.classList.add("is-visible")}),g&&g.addEventListener("change",f),I&&I.addEventListener("submit",d=>H(d,n)),m&&m.addEventListener("submit",d=>U(d,n));const i=document.getElementById("product-image");i&&i.addEventListener("change",k);const o=new URLSearchParams(window.location.search).get("edit_id");o?($(o,n),y("form-panel")):y("profile-panel")}function f(){const n=g.value,e=S[n];e&&L&&(L.textContent=e.unit),u.innerHTML='<option value="" disabled selected>-- Select Type --</option>',e?(u.disabled=!1,e.types.forEach(t=>{const a=document.createElement("option");a.value=t,a.textContent=t,u.appendChild(a)})):u.disabled=!0}function x(){C.forEach(n=>{n.id!=="dashboard-logout-btn"&&n.addEventListener("click",e=>{e.preventDefault();const t=n.dataset.panel;y(t)})})}function y(n){D.forEach(a=>a.classList.remove("active")),C.forEach(a=>a.classList.remove("active"));const e=document.getElementById(n);e&&e.classList.add("active");const t=document.querySelector(`.dashboard-nav-link[data-panel="${n}"]`);t&&(t.classList.add("active"),window.location.hash=t.hash)}async function F(n){const{data:e}=await l.from("profiles").select("full_name, phone_number, location").eq("id",n).single();e&&(document.getElementById("profile-name").value=e.full_name,document.getElementById("profile-phone").value=e.phone_number,document.getElementById("profile-location").value=e.location)}async function H(n,e){n.preventDefault(),p.disabled=!0,p.innerHTML='<span class="spinner"></span>Updating...';const t=document.getElementById("profile-name").value,a=R(document.getElementById("profile-phone").value),i=document.getElementById("profile-location").value,{error:o}=await l.from("profiles").update({full_name:t,phone_number:a,location:i}).eq("id",e);o?_(`Error: ${o.message}`,"error"):(_("Profile updated!","success"),document.getElementById("profile-phone").value=a),p.disabled=!1,p.innerHTML="Update Profile"}async function $(n,e){s("Loading listing...","success");const{data:t,error:a}=await l.from("listings").select("*").eq("id",n).eq("farmer_id",e).single();if(a||!t){s("Error loading listing.","error");return}document.getElementById("listing-id").value=t.id,document.getElementById("product-name").value=t.product_name,document.getElementById("product-price").value=t.price,document.getElementById("product-quantity").value=t.quantity_available,document.getElementById("product-location").value=t.location,document.getElementById("product-description").value=t.description,t.category&&S[t.category]?(g.value=t.category,f(),t.sub_category&&(u.value=t.sub_category)):(g.value="produce",f()),document.getElementById("form-title").innerHTML='<i class="fa-solid fa-pen-to-square icon"></i> Edit Listing',r.textContent="Update Listing";let i=document.getElementById("image-preview-wrapper");i||(i=document.createElement("div"),i.id="image-preview-wrapper",m.insertBefore(i,r)),i.innerHTML=`<img src="${t.main_image_url}" alt="Current image">`,s("Loaded. Make changes and Update.","success")}function k(n){const e=n.target.files[0];let t=document.getElementById("image-preview-wrapper");if(t||(t=document.createElement("div"),t.id="image-preview-wrapper",m.insertBefore(t,r)),t.innerHTML="",e){const a=new FileReader;a.onload=i=>{const o=document.createElement("img");o.src=i.target.result,t.appendChild(o)},a.readAsDataURL(e)}}async function U(n,e){n.preventDefault();const t=document.getElementById("listing-id").value;t?await N(n,e,t):await z(n,e),h(e)}async function z(n,e){if(!P())return;r.disabled=!0,r.innerHTML='<span class="spinner"></span>Uploading...';const t=M(),a=document.getElementById("product-image").files[0];if(!a){s("Image required.","error"),r.disabled=!1;return}const i=await T(a,e);if(!i){r.disabled=!1;return}t.main_image_url=i,t.farmer_id=e;const{error:o}=await l.from("listings").insert(t);o?s(o.message,"error"):(s("Listing posted successfully!","success"),m.reset(),document.getElementById("image-preview-wrapper").innerHTML="",f(),y("listings-panel")),r.disabled=!1,r.textContent="Post Listing"}async function N(n,e,t){if(!P())return;r.disabled=!0,r.innerHTML='<span class="spinner"></span>Updating...';const a=M(),i=document.getElementById("product-image").files[0];if(i){const d=await T(i,e);d&&(a.main_image_url=d)}const{error:o}=await l.from("listings").update(a).eq("id",t);o?s(o.message,"error"):(s("Listing updated!","success"),setTimeout(()=>s(""),3e3)),r.disabled=!1,r.textContent="Update Listing"}function M(){return{category:document.getElementById("product-category").value,sub_category:document.getElementById("product-subcategory").value,product_name:document.getElementById("product-name").value,price:document.getElementById("product-price").value,quantity_available:document.getElementById("product-quantity").value,location:document.getElementById("product-location").value,description:document.getElementById("product-description").value}}function P(){const n=document.getElementById("product-category").value,e=document.getElementById("product-subcategory").value,t=parseFloat(document.getElementById("product-price").value);return n?e?isNaN(t)||t<=0?(s("Price must be valid.","error"),!1):!0:(s("Please select a Sub-Category.","error"),!1):(s("Please select a Category.","error"),!1)}async function T(n,e){s("Uploading image...","success");const t=`public/${e}_${Date.now()}_${n.name.replace(/[^a-zA-Z0-9.]/g,"")}`,{error:a}=await l.storage.from("product_images").upload(t,n);if(a)return s(`Upload failed: ${a.message}`,"error"),null;const{data:i}=l.storage.from("product_images").getPublicUrl(t);return i.publicUrl}async function h(n){if(!b)return;c.textContent="Loading listings...";const{data:e,error:t}=await l.from("listings").select("*").eq("farmer_id",n).order("created_at",{ascending:!1});t?c.textContent="Error loading.":(b.innerHTML="",e.length===0?(c.textContent="No listings yet.",c.style.display="block"):(c.style.display="none",e.forEach(a=>{const i=document.createElement("div");i.className="listing-card",i.innerHTML=`
          <div class="listing-card-content" style="padding:1rem;">
            <h4 style="margin:0 0 0.5rem 0; font-size:1rem; color:#666; text-transform:uppercase; font-size:0.8rem; font-weight:700;">
              ${a.category||"Produce"} - ${a.sub_category||"General"}
            </h4>
            <h3 style="margin:0 0 0.5rem 0;">${a.product_name}</h3>
            <p style="color:var(--primary-color); font-weight:700;">$${a.price}</p>
          </div>
          <div class="listing-card-actions" style="padding:0 1rem 1rem 1rem; display:flex; gap:0.5rem;">
            <a href="/dashboard.html?edit_id=${a.id}" class="btn edit-btn" style="flex:1; text-align:center;">Edit</a>
            <button class="btn delete-btn" data-id="${a.id}" style="flex:1;">Delete</button>
          </div>
        `,i.querySelector(".delete-btn").addEventListener("click",()=>A(a.id,n)),b.appendChild(i)})))}async function A(n,e){confirm("Delete this listing?")&&(await l.from("listings").delete().eq("id",n).eq("farmer_id",e),h(e))}function s(n,e){v&&(v.textContent=n,v.className=e)}function _(n,e){E&&(E.textContent=n,E.className=e)}function R(n){let e=n.replace(/\D/g,"");return e.startsWith("0")&&(e=e.substring(1)),e.startsWith("263")||(e="263"+e),"+"+e}export{V as initDashboardPage};
